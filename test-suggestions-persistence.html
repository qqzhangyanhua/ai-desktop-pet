<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Suggestions æŒä¹…åŒ–æµ‹è¯•</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #333;
      margin-top: 0;
    }
    button {
      background: #a78bfa;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #9370db;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    pre {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: #10b981; font-weight: bold; }
    .error { color: #ef4444; font-weight: bold; }
    .warning { color: #f59e0b; font-weight: bold; }
    input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 400px;
      margin-right: 10px;
    }
    .step {
      background: #e0e7ff;
      padding: 10px;
      margin: 10px 0;
      border-left: 4px solid #6366f1;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>ğŸ“¦ Suggestions æŒä¹…åŒ–åŠŸèƒ½æµ‹è¯•</h1>

  <div class="test-section">
    <h2>æµ‹è¯•æµç¨‹</h2>
    <div class="step">
      <strong>æ­¥éª¤ 1</strong>: åˆå§‹åŒ–æ•°æ®åº“å¹¶è¿è¡Œè¿ç§»
    </div>
    <div class="step">
      <strong>æ­¥éª¤ 2</strong>: ä¿å­˜å¸¦æœ‰ suggestions çš„æ¶ˆæ¯
    </div>
    <div class="step">
      <strong>æ­¥éª¤ 3</strong>: ä»æ•°æ®åº“åŠ è½½æ¶ˆæ¯
    </div>
    <div class="step">
      <strong>æ­¥éª¤ 4</strong>: éªŒè¯ suggestions æ­£ç¡®ååºåˆ—åŒ–
    </div>
  </div>

  <div class="test-section">
    <h2>æ­¥éª¤ 1: åˆå§‹åŒ–æ•°æ®åº“</h2>
    <button onclick="initDatabase()">åˆå§‹åŒ–æ•°æ®åº“</button>
    <pre id="init-result">ç­‰å¾…æ“ä½œ...</pre>
  </div>

  <div class="test-section">
    <h2>æ­¥éª¤ 2: åˆ›å»ºå¯¹è¯å¹¶ä¿å­˜æ¶ˆæ¯</h2>
    <button onclick="createConversation()">åˆ›å»ºæµ‹è¯•å¯¹è¯</button>
    <button onclick="saveMessageWithSuggestions()" id="save-btn" disabled>ä¿å­˜å¸¦å»ºè®®çš„æ¶ˆæ¯</button>
    <pre id="save-result">ç­‰å¾…æ“ä½œ...</pre>
  </div>

  <div class="test-section">
    <h2>æ­¥éª¤ 3: åŠ è½½æ¶ˆæ¯</h2>
    <button onclick="loadMessages()" id="load-btn" disabled>åŠ è½½æ¶ˆæ¯</button>
    <pre id="load-result">ç­‰å¾…æ“ä½œ...</pre>
  </div>

  <div class="test-section">
    <h2>æ­¥éª¤ 4: éªŒè¯ç»“æœ</h2>
    <button onclick="verifyPersistence()" id="verify-btn" disabled>éªŒè¯æŒä¹…åŒ–</button>
    <pre id="verify-result">ç­‰å¾…æ“ä½œ...</pre>
  </div>

  <script type="module">
    import { initDatabase, getDatabase } from './src/services/database/index.js';
    import { createConversation as dbCreateConversation, addMessage, getMessages } from './src/services/database/conversations.js';

    let conversationId = null;
    let savedMessageId = null;

    window.initDatabase = async function() {
      const result = document.getElementById('init-result');
      try {
        result.textContent = 'åˆå§‹åŒ–ä¸­...';

        const db = await initDatabase();
        result.innerHTML = `<span class="success">âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ</span>\n\næ•°æ®åº“å®ä¾‹: ${!!db}\n\næŸ¥çœ‹æ§åˆ¶å°æŸ¥çœ‹è¿ç§»æ—¥å¿—`;

        console.log('[Test] Database initialized:', db);
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ åˆå§‹åŒ–å¤±è´¥</span>\n\n${error.message}\n\n${error.stack}`;
      }
    };

    window.createConversation = async function() {
      const result = document.getElementById('save-result');
      try {
        result.textContent = 'åˆ›å»ºå¯¹è¯ä¸­...';

        const conversation = await dbCreateConversation('æµ‹è¯• Suggestions æŒä¹…åŒ–', 'æµ‹è¯•ç³»ç»Ÿæç¤º');
        conversationId = conversation.id;

        result.innerHTML = `<span class="success">âœ… å¯¹è¯åˆ›å»ºæˆåŠŸ</span>\n\nå¯¹è¯ ID: ${conversationId}\næ ‡é¢˜: ${conversation.title}`;

        document.getElementById('save-btn').disabled = false;

        console.log('[Test] Conversation created:', conversation);
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ åˆ›å»ºå¤±è´¥</span>\n\n${error.message}`;
      }
    };

    window.saveMessageWithSuggestions = async function() {
      const result = document.getElementById('save-result');
      try {
        if (!conversationId) {
          result.innerHTML = `<span class="error">âŒ è¯·å…ˆåˆ›å»ºå¯¹è¯</span>`;
          return;
        }

        result.textContent = 'ä¿å­˜æ¶ˆæ¯ä¸­...';

        const testSuggestions = [
          'æŸ¥æ‰¾æˆ‘çš„CSSä¹¦ç­¾',
          'CSSç›¸å…³ä¹¦ç­¾æŸ¥è¯¢',
          'æˆ‘çš„å±‚å æ ·å¼è¡¨ä¹¦ç­¾'
        ];

        const message = await addMessage(conversationId, {
          role: 'assistant',
          content: 'æ²¡æœ‰æ‰¾åˆ°åŒ…å«"css"çš„ä¹¦ç­¾\n\nğŸ¤” è¦ä¸è¯•è¯•è¿™äº›ï¼š',
          suggestions: testSuggestions,
        });

        savedMessageId = message.id;

        result.innerHTML = `<span class="success">âœ… æ¶ˆæ¯ä¿å­˜æˆåŠŸ</span>\n\næ¶ˆæ¯ ID: ${message.id}\nå†…å®¹: ${message.content}\nå»ºè®®æ•°é‡: ${message.suggestions?.length ?? 0}\nå»ºè®®å†…å®¹: ${JSON.stringify(message.suggestions, null, 2)}`;

        document.getElementById('load-btn').disabled = false;

        console.log('[Test] Message saved:', message);
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ ä¿å­˜å¤±è´¥</span>\n\n${error.message}\n\n${error.stack}`;
      }
    };

    window.loadMessages = async function() {
      const result = document.getElementById('load-result');
      try {
        if (!conversationId) {
          result.innerHTML = `<span class="error">âŒ è¯·å…ˆåˆ›å»ºå¯¹è¯</span>`;
          return;
        }

        result.textContent = 'åŠ è½½æ¶ˆæ¯ä¸­...';

        const messages = await getMessages(conversationId);

        if (messages.length === 0) {
          result.innerHTML = `<span class="warning">âš ï¸ æœªæ‰¾åˆ°æ¶ˆæ¯</span>`;
          return;
        }

        const messageWithSuggestions = messages.find(m => m.suggestions && m.suggestions.length > 0);

        if (!messageWithSuggestions) {
          result.innerHTML = `<span class="warning">âš ï¸ æœªæ‰¾åˆ°å¸¦å»ºè®®çš„æ¶ˆæ¯</span>\n\nå…±åŠ è½½ ${messages.length} æ¡æ¶ˆæ¯`;
          return;
        }

        result.innerHTML = `<span class="success">âœ… æ¶ˆæ¯åŠ è½½æˆåŠŸ</span>\n\nå…±åŠ è½½æ¶ˆæ¯: ${messages.length} æ¡\n\nå¸¦å»ºè®®çš„æ¶ˆæ¯:\nID: ${messageWithSuggestions.id}\nå†…å®¹: ${messageWithSuggestions.content}\nå»ºè®®: ${JSON.stringify(messageWithSuggestions.suggestions, null, 2)}`;

        document.getElementById('verify-btn').disabled = false;

        console.log('[Test] Messages loaded:', messages);
        console.log('[Test] Message with suggestions:', messageWithSuggestions);
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ åŠ è½½å¤±è´¥</span>\n\n${error.message}\n\n${error.stack}`;
      }
    };

    window.verifyPersistence = async function() {
      const result = document.getElementById('verify-result');
      try {
        if (!conversationId || !savedMessageId) {
          result.innerHTML = `<span class="error">âŒ è¯·å…ˆå®Œæˆå‰é¢çš„æ­¥éª¤</span>`;
          return;
        }

        result.textContent = 'éªŒè¯ä¸­...';

        const messages = await getMessages(conversationId);
        const savedMessage = messages.find(m => m.id === savedMessageId);

        if (!savedMessage) {
          result.innerHTML = `<span class="error">âŒ éªŒè¯å¤±è´¥ï¼šæœªæ‰¾åˆ°å·²ä¿å­˜çš„æ¶ˆæ¯</span>`;
          return;
        }

        // éªŒè¯ suggestions å­—æ®µ
        const checks = {
          hasSuggestions: !!savedMessage.suggestions,
          isArray: Array.isArray(savedMessage.suggestions),
          correctLength: savedMessage.suggestions?.length === 3,
          firstSuggestion: savedMessage.suggestions?.[0] === 'æŸ¥æ‰¾æˆ‘çš„CSSä¹¦ç­¾',
          secondSuggestion: savedMessage.suggestions?.[1] === 'CSSç›¸å…³ä¹¦ç­¾æŸ¥è¯¢',
          thirdSuggestion: savedMessage.suggestions?.[2] === 'æˆ‘çš„å±‚å æ ·å¼è¡¨ä¹¦ç­¾',
        };

        const allPassed = Object.values(checks).every(v => v === true);

        result.innerHTML = `
<span class="${allPassed ? 'success' : 'error'}">${allPassed ? 'âœ… éªŒè¯é€šè¿‡' : 'âŒ éªŒè¯å¤±è´¥'}</span>

<strong>éªŒè¯é¡¹:</strong>
âœ“ suggestions å­—æ®µå­˜åœ¨: ${checks.hasSuggestions ? 'âœ…' : 'âŒ'}
âœ“ suggestions æ˜¯æ•°ç»„: ${checks.isArray ? 'âœ…' : 'âŒ'}
âœ“ å»ºè®®æ•°é‡æ­£ç¡®(3): ${checks.correctLength ? 'âœ…' : 'âŒ'}
âœ“ ç¬¬1ä¸ªå»ºè®®æ­£ç¡®: ${checks.firstSuggestion ? 'âœ…' : 'âŒ'}
âœ“ ç¬¬2ä¸ªå»ºè®®æ­£ç¡®: ${checks.secondSuggestion ? 'âœ…' : 'âŒ'}
âœ“ ç¬¬3ä¸ªå»ºè®®æ­£ç¡®: ${checks.thirdSuggestion ? 'âœ…' : 'âŒ'}

<strong>å®é™…æ•°æ®:</strong>
${JSON.stringify(savedMessage.suggestions, null, 2)}

<strong>ç»“è®º:</strong>
${allPassed ?
  'ğŸ‰ Suggestions æŒä¹…åŒ–åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼\n   - æ•°æ®æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“\n   - æ•°æ®æ­£ç¡®åºåˆ—åŒ–ä¸º JSON\n   - æ•°æ®æ­£ç¡®ååºåˆ—åŒ–ä¸ºæ•°ç»„\n   - å†…å®¹å®Œæ•´æ— ä¸¢å¤±' :
  'âš ï¸ å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°å¤±è´¥é¡¹'}
        `;

        console.log('[Test] Verification result:', checks);
        console.log('[Test] Saved message:', savedMessage);
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ éªŒè¯å¤±è´¥</span>\n\n${error.message}\n\n${error.stack}`;
      }
    };
  </script>
</body>
</html>
