# Chrome 书签集成 - 系统架构图

## 整体架构

```
┌──────────────────────────────────────────────────────────────────┐
│                        用户界面层 (UI Layer)                       │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────┐     ┌──────────────────┐                   │
│  │  Chat Window    │     │ Settings Panel   │                   │
│  │  聊天窗口        │     │ 设置面板          │                   │
│  └────────┬────────┘     └────────┬─────────┘                   │
│           │                       │                             │
└───────────┼───────────────────────┼─────────────────────────────┘
            │                       │
            ▼                       ▼
┌──────────────────────────────────────────────────────────────────┐
│                      应用逻辑层 (Logic Layer)                      │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────┐         ┌──────────────────┐              │
│  │  useChat Hook    │         │ useBookmark Hook │              │
│  │  聊天业务逻辑     │         │ 书签业务逻辑      │              │
│  └────────┬─────────┘         └────────┬─────────┘              │
│           │                            │                        │
│           ▼                            │                        │
│  ┌─────────────────────────────────────┼─────────────┐          │
│  │         Intent System 意图识别系统   │             │          │
│  ├─────────────────────────────────────┘             │          │
│  │                                                    │          │
│  │  ┌──────────────────┐    ┌──────────────────┐    │          │
│  │  │ Intent Recognizer│───▶│ BookmarkIntent   │    │          │
│  │  │  意图识别器       │    │  Handler         │    │          │
│  │  └──────────────────┘    └────────┬─────────┘    │          │
│  │                                    │              │          │
│  └────────────────────────────────────┼──────────────┘          │
│                                       ▼                         │
│           ┌────────────────────────────────────────┐            │
│           │     Agent System 智能体系统            │            │
│           ├────────────────────────────────────────┤            │
│           │                                        │            │
│           │  ┌───────────────────────────────┐    │            │
│           │  │  Agent Runtime 运行时          │    │            │
│           │  └───────────┬───────────────────┘    │            │
│           │              │                        │            │
│           │              ▼                        │            │
│           │  ┌───────────────────────────────┐    │            │
│           │  │  Built-in Tools 内置工具       │    │            │
│           │  ├───────────────────────────────┤    │            │
│           │  │  • BookmarkSearchTool         │    │            │
│           │  │  • GetBookmarkByIdTool        │    │            │
│           │  │  • ListRecentBookmarksTool    │    │            │
│           │  │  • SearchTool (网络搜索)      │    │            │
│           │  │  • OpenerTool (打开URL)       │    │            │
│           │  │  • ...                        │    │            │
│           │  └───────────┬───────────────────┘    │            │
│           │              │                        │            │
│           └──────────────┼────────────────────────┘            │
│                          │                                     │
└──────────────────────────┼─────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────┐
│                      服务层 (Service Layer)                       │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │         ChromeBookmarkService 核心服务                     │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  ┌──────────────────┐      ┌──────────────────┐         │   │
│  │  │  File Reader     │      │  Memory Cache    │         │   │
│  │  │  文件读取器       │      │  内存缓存         │         │   │
│  │  └────────┬─────────┘      └────────┬─────────┘         │   │
│  │           │                         │                   │   │
│  │           │  ┌──────────────────────┤                   │   │
│  │           │  │                      │                   │   │
│  │           ▼  ▼                      ▼                   │   │
│  │  ┌──────────────────┐      ┌──────────────────┐         │   │
│  │  │  JSON Parser     │      │  Cache Manager   │         │   │
│  │  │  JSON 解析器     │      │  缓存管理器       │         │   │
│  │  └────────┬─────────┘      └──────────────────┘         │   │
│  │           │                                             │   │
│  │           ▼                                             │   │
│  │  ┌──────────────────┐                                   │   │
│  │  │  Tree Flattener  │                                   │   │
│  │  │  树结构扁平化     │                                   │   │
│  │  └────────┬─────────┘                                   │   │
│  │           │                                             │   │
│  │           ▼                                             │   │
│  │  ┌──────────────────┐                                   │   │
│  │  │  Index Builder   │                                   │   │
│  │  │  索引构建器       │                                   │   │
│  │  └────────┬─────────┘                                   │   │
│  │           │                                             │   │
│  │           ▼                                             │   │
│  │  ┌──────────────────────────────────┐                   │   │
│  │  │  Search Engine 搜索引擎          │                   │   │
│  │  ├──────────────────────────────────┤                   │   │
│  │  │  • Keyword Matching 关键词匹配   │                   │   │
│  │  │  • Scoring Algorithm 评分算法    │                   │   │
│  │  │  • Result Sorting 结果排序       │                   │   │
│  │  └──────────────────────────────────┘                   │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└──────────────────────────┬───────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │       Tauri File System API (@tauri-apps/plugin-fs)      │   │
│  └────────────────────────┬─────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │        Chrome Bookmarks File (JSON)                      │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  macOS:    ~/Library/Application Support/Google/Chrome/ │   │
│  │            Default/Bookmarks                             │   │
│  │                                                          │   │
│  │  Windows:  %LOCALAPPDATA%\Google\Chrome\User Data\      │   │
│  │            Default\Bookmarks                             │   │
│  │                                                          │   │
│  │  Linux:    ~/.config/google-chrome/Default/Bookmarks    │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 数据流图

### 场景1：用户搜索书签

```
用户输入: "我的 GitHub 书签"
    │
    ▼
┌─────────────────┐
│ Intent          │  识别意图: bookmark/search
│ Recognizer      │  关键词: "GitHub"
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ BookmarkIntent  │  快速响应路径
│ Handler         │  (不经过 Agent)
└────────┬────────┘
         │
         ▼
┌─────────────────────────────┐
│ ChromeBookmarkService       │
│ .searchBookmarks({          │
│   query: "GitHub",          │
│   limit: 10                 │
│ })                          │
└────────┬────────────────────┘
         │
         ▼
┌─────────────────┐
│ Cache Check     │  检查缓存 (5min TTL)
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
缓存命中    缓存未命中
    │         │
    │         ▼
    │    ┌─────────────────┐
    │    │ Read File       │  readTextFile(path)
    │    └────────┬────────┘
    │             │
    │             ▼
    │    ┌─────────────────┐
    │    │ Parse JSON      │  JSON.parse(content)
    │    └────────┬────────┘
    │             │
    │             ▼
    │    ┌─────────────────┐
    │    │ Validate Schema │  Zod validation
    │    └────────┬────────┘
    │             │
    │             ▼
    │    ┌─────────────────┐
    │    │ Build Index     │  扁平化 + 建立索引
    │    └────────┬────────┘
    │             │
    │             ▼
    │    ┌─────────────────┐
    │    │ Cache Data      │  存入内存缓存
    │    └────────┬────────┘
    │             │
    └─────────────┘
         │
         ▼
┌─────────────────┐
│ Search          │  关键词匹配 + 评分
│ Algorithm       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Sort Results    │  按得分排序
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Format Output   │  格式化为文本
└────────┬────────┘
         │
         ▼
    返回给用户
```

---

### 场景2：Agent 调用书签工具

```
用户输入: "帮我找找关于 React 的书签"
    │
    ▼
┌─────────────────┐
│ LLM             │  理解意图 + 生成工具调用
│ (GPT/Claude)    │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────┐
│ Tool Call 工具调用               │
│                                 │
│ {                               │
│   "name": "search_bookmarks",   │
│   "arguments": {                │
│     "query": "React",           │
│     "limit": 10                 │
│   }                             │
│ }                               │
└────────┬────────────────────────┘
         │
         ▼
┌─────────────────┐
│ Agent Runtime   │  路由到对应工具
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│ BookmarkSearchTool      │  继承 BaseTool
│ .execute(arguments)     │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────────┐
│ ChromeBookmarkService       │  (同场景1)
│ .searchBookmarks()          │
└────────┬────────────────────┘
         │
         ▼
┌─────────────────┐
│ Format Result   │  格式化为 Markdown
│                 │  带序号、URL、路径
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Return to LLM   │  工具返回值
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ LLM Generate    │  基于结果生成回复
│ Response        │
└────────┬────────┘
         │
         ▼
    返回给用户
```

---

## 缓存机制

```
┌─────────────────────────────────────────┐
│         Memory Cache 内存缓存            │
├─────────────────────────────────────────┤
│                                         │
│  cache: BookmarkIndex | null            │
│  lastLoadTime: number                   │
│  cacheTTL: 5 * 60 * 1000 (5分钟)        │
│                                         │
│  getBookmarks() {                       │
│    if (缓存有效) {                       │
│      return cache;  // < 1ms           │
│    }                                    │
│    cache = loadFromFile();  // 200ms   │
│    lastLoadTime = now;                  │
│    return cache;                        │
│  }                                      │
│                                         │
└─────────────────────────────────────────┘

时间线:
T0:   首次调用 → 读取文件 (200ms)
T1:   2分钟后 → 缓存命中 (< 1ms)
T5:   5分钟后 → 缓存过期 → 重新加载 (200ms)
T6:   6分钟后 → 缓存命中 (< 1ms)
```

---

## 搜索算法流程

```
输入: query = "react docs"
      bookmarks = [1000个书签]

    │
    ▼
┌──────────────────────────┐
│ 1. 预处理                 │
│    query = "react docs"   │
│    .toLowerCase()         │
│    .trim()                │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────────────┐
│ 2. 遍历所有书签                   │
│    for bookmark in bookmarks:    │
│      score = calculateScore()    │
└────────┬─────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────┐
│ 3. 评分算法 calculateScore()                  │
├──────────────────────────────────────────────┤
│                                              │
│  score = 0                                   │
│                                              │
│  ┌────────────────────────────────┐          │
│  │ URL 精确匹配 +100              │          │
│  │ url.includes("react docs")     │          │
│  └────────────────────────────────┘          │
│                                              │
│  ┌────────────────────────────────┐          │
│  │ 标题精确匹配 +80               │          │
│  │ name === "react docs"          │          │
│  └────────────────────────────────┘          │
│                                              │
│  ┌────────────────────────────────┐          │
│  │ 标题包含 +50                   │          │
│  │ name.includes("react docs")    │          │
│  │   - 开头匹配 +10               │          │
│  └────────────────────────────────┘          │
│                                              │
│  ┌────────────────────────────────┐          │
│  │ URL 域名匹配 +30               │          │
│  │ hostname.includes("react")     │          │
│  └────────────────────────────────┘          │
│                                              │
│  ┌────────────────────────────────┐          │
│  │ 路径匹配 +20                   │          │
│  │ path.includes("react")         │          │
│  └────────────────────────────────┘          │
│                                              │
│  return score                                │
│                                              │
└────────┬─────────────────────────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 4. 过滤低分结果           │
│    filter(score > 0)     │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 5. 排序                  │
│    sort((a,b) =>         │
│      b.score - a.score)  │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 6. 限制结果数量           │
│    slice(0, limit)       │
└────────┬─────────────────┘
         │
         ▼
    返回搜索结果
```

---

## 类型系统结构

```
src/types/bookmark.ts
├── ChromeBookmarkNode          # Chrome 原始节点
│   ├── id: string
│   ├── name: string
│   ├── type: 'url' | 'folder'
│   ├── url?: string
│   ├── date_added?: string
│   └── children?: ChromeBookmarkNode[]
│
├── ChromeBookmarksFile         # Chrome 文件根结构
│   ├── version: number
│   ├── checksum: string
│   └── roots
│       ├── bookmark_bar: ChromeBookmarkNode
│       ├── other: ChromeBookmarkNode
│       └── synced: ChromeBookmarkNode
│
├── FlatBookmark                # 扁平化书签
│   ├── id: string
│   ├── name: string
│   ├── url: string
│   ├── dateAdded: Date
│   ├── path: string[]
│   └── source: 'bookmark_bar' | 'other' | 'synced'
│
├── BookmarkIndex               # 书签索引
│   ├── byId: Map<string, FlatBookmark>
│   ├── byUrl: Map<string, FlatBookmark>
│   ├── flatList: FlatBookmark[]
│   └── lastUpdated: Date
│
├── BookmarkSearchResult        # 搜索结果
│   ├── bookmark: FlatBookmark
│   ├── score: number
│   └── matchType: 'exact_url' | 'exact_title' | ...
│
└── BookmarkSearchOptions       # 搜索参数
    ├── query: string
    ├── limit?: number
    └── minScore?: number
```

---

## 错误处理流程

```
┌─────────────────────────────────────┐
│  ChromeBookmarkService              │
│  .getBookmarks()                    │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  try {                              │
│    path = getBookmarksPath()        │
│    content = readTextFile(path)     │
│    data = JSON.parse(content)       │
│    validateSchema(data)             │
│    index = buildIndex(data)         │
│    return index                     │
│  }                                  │
└────────┬────────────────────────────┘
         │
         ▼
    发生错误?
         │
    ┌────┴────┐
    是        否
    │         │
    ▼         └──────▶ 返回结果
┌─────────────────────────────────────┐
│  catch (error) {                    │
│                                     │
│    if (error.includes('No such'))   │
│      throw "Chrome 未安装"           │
│                                     │
│    if (error.includes('locked'))    │
│      throw "文件被锁定"              │
│                                     │
│    if (error.includes('parse'))     │
│      throw "文件格式错误"            │
│                                     │
│    if (error.includes('version'))   │
│      throw "版本不支持"              │
│                                     │
│    throw "读取书签失败"              │
│  }                                  │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  UI Layer 错误展示                   │
│                                     │
│  if (error) {                       │
│    return <ErrorMessage>            │
│      {error}                        │
│    </ErrorMessage>                  │
│  }                                  │
└─────────────────────────────────────┘
```

---

## 性能优化点

```
┌─────────────────────────────────────────────────────────┐
│                  性能优化策略                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. 缓存优化                                            │
│     ┌──────────────────────────────┐                   │
│     │ 内存缓存 (5分钟 TTL)          │  < 1ms           │
│     │ 避免重复读取文件              │                   │
│     └──────────────────────────────┘                   │
│                                                         │
│  2. 索引优化                                            │
│     ┌──────────────────────────────┐                   │
│     │ Map 数据结构 (O(1) 查找)     │  < 1ms           │
│     │ byId, byUrl 快速查找          │                   │
│     └──────────────────────────────┘                   │
│                                                         │
│  3. 懒加载                                              │
│     ┌──────────────────────────────┐                   │
│     │ 首次使用时才加载              │  节省启动时间    │
│     │ 不在应用启动时加载            │                   │
│     └──────────────────────────────┘                   │
│                                                         │
│  4. 搜索算法优化                                        │
│     ┌──────────────────────────────┐                   │
│     │ 简单评分系统 (无复杂计算)     │  < 10ms          │
│     │ 避免正则表达式                │                   │
│     └──────────────────────────────┘                   │
│                                                         │
│  5. 结果限制                                            │
│     ┌──────────────────────────────┐                   │
│     │ 默认只返回前 10 条            │  减少渲染开销    │
│     │ slice(0, limit)              │                   │
│     └──────────────────────────────┘                   │
│                                                         │
│  6. React 优化                                          │
│     ┌──────────────────────────────┐                   │
│     │ useCallback 缓存函数          │  减少重渲染      │
│     │ useMemo 缓存结果              │                   │
│     └──────────────────────────────┘                   │
│                                                         │
└─────────────────────────────────────────────────────────┘

性能指标:
┌────────────────────────┬──────────┬──────────┐
│ 操作                   │ 首次     │ 缓存命中 │
├────────────────────────┼──────────┼──────────┤
│ 读取文件               │ 50ms     │ 0ms      │
│ 解析 JSON             │ 30ms     │ 0ms      │
│ 建立索引               │ 100ms    │ 0ms      │
│ 搜索                   │ 10ms     │ 10ms     │
│ 总计                   │ ~200ms   │ ~10ms    │
└────────────────────────┴──────────┴──────────┘
```

---

## 安全性架构

```
┌─────────────────────────────────────────────────────────┐
│                  安全性设计                              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. Tauri 权限控制                                      │
│     ┌──────────────────────────────┐                   │
│     │ capabilities/default.json    │                   │
│     │ ├── fs:read-text-file        │  只读权限        │
│     │ └── path:resolve-home-dir    │  路径解析        │
│     └──────────────────────────────┘                   │
│                                                         │
│  2. 数据验证                                            │
│     ┌──────────────────────────────┐                   │
│     │ Zod Schema Validation        │  格式验证        │
│     │ 拒绝非法数据                  │                   │
│     └──────────────────────────────┘                   │
│                                                         │
│  3. 本地处理                                            │
│     ┌──────────────────────────────┐                   │
│     │ 数据不上传                    │  隐私保护        │
│     │ 仅在本地处理                  │                   │
│     └──────────────────────────────┘                   │
│                                                         │
│  4. 用户控制                                            │
│     ┌──────────────────────────────┐                   │
│     │ 设置中提供开关                │  用户自主        │
│     │ 透明说明读取行为              │                   │
│     └──────────────────────────────┘                   │
│                                                         │
│  5. 错误隔离                                            │
│     ┌──────────────────────────────┐                   │
│     │ try/catch 包裹所有操作        │  避免崩溃        │
│     │ 友好的错误提示                │                   │
│     └──────────────────────────────┘                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

**文档版本**: 1.0
**创建日期**: 2026-01-01
**图表工具**: ASCII Art
