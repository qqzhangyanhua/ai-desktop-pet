# 已知限制与未来改进

**更新日期**: 2025-12-26
**版本**: Sprint 4 - Phase 1 完成

---

## 功能限制

### 1. 宠物养成系统

#### 当前实现
- ✅ 三个基础属性：mood, energy, intimacy
- ✅ 时间衰减机制（mood, energy）
- ✅ 三种互动类型：抚摸、喂食、玩耍
- ✅ 冷却时间限制
- ✅ 视觉反馈（飘字动画）
- ✅ 表情自动切换

#### 未实现功能
- ❌ 音效反馈
- ❌ UI 上显示剩余冷却时间进度条
- ❌ 更丰富的互动类型（如：训练、睡觉、洗澡）
- ❌ 成就系统
- ❌ 等级系统
- ❌ 特殊状态（如：生病、快乐、疲惫）

#### 设计权衡
**为什么没有等级系统？**
- 遵循 Linus 的实用主义原则：解决实际问题，不是假想的威胁
- 当前版本专注于核心互动体验
- 等级系统会增加复杂度，但用户价值未经验证
- 可在未来版本根据用户反馈添加

**为什么 intimacy 无上限？**
- 允许长期用户积累情感连接
- 不破坏现有用户的数据（Never break userspace）
- 简化边界检查逻辑

---

## 性能限制

### 1. 数据库写入频率

**当前实现**: 5秒防抖

**限制**:
- 应用关闭时可能丢失最后5秒内的自动衰减更新
- 用户互动使用 `updateStatusImmediate()`，不受影响

**影响评估**: 低
- 5秒的衰减损失可以忽略（mood/energy 每分钟衰减约 0.033-0.05）
- 用户感知不到差异

**未来改进**:
- 在 App unmount 时 flush pending updates
- 添加 `beforeunload` 事件监听器

### 2. 衰减计算缓存

**当前实现**: 60秒缓存

**限制**:
- 缓存失效后第一次调用会重新计算
- 服务重启会清空缓存（内存中）

**影响评估**: 极低
- 缓存命中率预计 > 80%
- 重新计算耗时 < 1ms

### 3. React 渲染优化

**当前实现**:
- StatusBar 使用 React.memo
- usePetStatus 使用 useMemo 稳定返回值

**限制**:
- 只优化了 StatusBar，其他组件未优化
- PetContainer 未使用 memo（因为包含交互逻辑）

**影响评估**: 低
- StatusBar 是最频繁更新的组件
- PetContainer 重渲染频率低（仅在互动时）

---

## 技术债务

### 1. 测试覆盖率

**当前状态**:
- ✅ 静态代码审查完成
- ✅ TypeScript 编译通过
- ❌ 无单元测试
- ❌ 无集成测试
- ❌ 无 E2E 测试

**原因**:
- Sprint 4 专注于功能实现
- 测试基础设施尚未建立

**未来计划**:
- Sprint 5+: 添加 Vitest 单元测试
- 优先测试核心逻辑：status.ts, interaction.ts, emotion.ts

### 2. 错误处理

**当前实现**:
- ✅ 数据库操作有 try-catch
- ✅ 失败时显示 toast
- ✅ 不会导致应用崩溃

**限制**:
- 错误信息对用户不够友好
- 无错误日志收集
- 无错误恢复机制（如重试）

**未来改进**:
- 添加友好的错误提示文案
- 集成错误监控（如 Sentry）
- 实现自动重试机制

### 3. 代码注释

**当前状态**:
- ✅ 所有 service 函数有 JSDoc
- ✅ 复杂逻辑有内联注释
- ⚠️ 部分组件注释不足

**未来改进**:
- 为所有 React 组件添加顶部注释
- 为复杂的 hook 添加使用示例

---

## 架构限制

### 1. 状态持久化

**当前实现**: SQLite

**限制**:
- 数据存储在本地，无云同步
- 跨设备无法共享宠物状态
- 无数据备份机制（用户需手动）

**设计决策**:
- 隐私优先：用户数据不上传服务器
- 简化架构：无需后端服务

**未来可能**:
- 可选的云同步（用户主动开启）
- 导出/导入功能（已实现）

### 2. 互动区域检测

**当前实现**: 垂直三等分（上/中/下）

**限制**:
- 区域划分不够直观
- 无视觉提示告知用户哪个区域对应哪个互动
- 点击小宠物时准确性不高

**已知问题**:
- 用户可能需要尝试才知道互动区域
- 新用户学习成本较高

**未来改进**:
- 添加悬停提示（hover tooltip）
- 添加首次使用引导
- 改为基于 Live2D 模型的部位检测（头部、身体、脚部）

### 3. 属性衰减算法

**当前实现**: 线性衰减

```typescript
// mood: 每小时 -2
// energy: 每小时 -1.5
```

**限制**:
- 过于简单，缺乏变化
- 不考虑其他因素（如 intimacy 高时衰减慢）
- 无昼夜差异（晚上 energy 衰减应该更快）

**设计决策**:
- "好品味"原则：简单清晰胜过复杂理论
- 线性衰减易于理解和调试

**未来可能**:
- 根据 intimacy 调整衰减速率
- 添加昼夜节律影响
- 考虑互动频率（长期不互动加速衰减）

---

## 浏览器/平台兼容性

### 1. Tauri 限制

**支持平台**: macOS, Windows, Linux

**已知问题**:
- macOS 上偶现 `RemoteLayerTreeDrawingAreaProxyMac` 警告（无功能影响）
- Linux 上需要额外依赖（webkit2gtk）

### 2. Live2D 性能

**限制**:
- oh-my-live2d 库较大（~2MB）
- 首次加载较慢
- 占位符模式性能更好，但缺乏表现力

**优化措施**:
- Live2D 模块独立打包（live2d-vendor chunk）
- 用户可选择禁用 Live2D 使用占位符

---

## 用户体验限制

### 1. 反馈机制

**当前实现**:
- ✅ 飘字动画
- ✅ StatusBar 进度条
- ✅ Toast 提示

**缺失**:
- ❌ 音效
- ❌ 震动反馈（桌面端不支持）
- ❌ 粒子效果（如心形、星星）

### 2. 可访问性

**当前状态**:
- ❌ 无键盘导航支持
- ❌ 无屏幕阅读器支持
- ❌ 无高对比度模式

**未来计划**:
- 添加 ARIA 标签
- 支持 Tab 键导航
- 添加焦点指示器

---

## 数据模型限制

### 1. PetStatus Schema

**当前字段**:
```sql
mood REAL DEFAULT 80.0
energy REAL DEFAULT 100.0
intimacy REAL DEFAULT 0.0
last_interaction INTEGER
last_feed INTEGER
last_play INTEGER
total_interactions INTEGER
```

**缺失字段**:
- `level` - 等级
- `experience` - 经验值
- `hunger` - 饥饿度（独立于 energy）
- `health` - 健康值
- `cleanliness` - 清洁度
- `mood_history` - 心情历史记录

**迁移风险**:
- 添加新字段需要数据库迁移
- 需要保证向后兼容（Never break userspace）

---

## 安全限制

### 1. 输入验证

**当前状态**:
- ✅ 属性值边界检查（0-100）
- ✅ TypeScript 类型检查

**限制**:
- 无 SQL 注入防护（使用参数化查询已缓解）
- 无 XSS 防护（React 自动转义已缓解）

### 2. 数据加密

**当前状态**:
- ❌ 数据库未加密
- ❌ 无敏感信息保护

**风险评估**: 低
- 宠物状态数据不包含敏感信息
- 本地应用，无网络传输

---

## 总结

### 关键原则

遵循 Linus Torvalds 的哲学：

1. **"好品味"优先** - 线性衰减胜过复杂公式
2. **实用主义** - 实现真实需求，不是假想功能
3. **Never break userspace** - 所有改动保证向后兼容
4. **简洁执念** - 避免过度设计

### 技术债务优先级

**P0 (必须修复)**:
- 无

**P1 (高优先级)**:
- 添加单元测试覆盖
- 改进错误提示文案

**P2 (中优先级)**:
- 互动区域可视化提示
- 应用关闭时 flush pending updates
- 添加更多控制台日志

**P3 (低优先级)**:
- 音效反馈
- 可访问性支持
- 数据加密

### 不会实现的功能

基于"实用主义"原则，以下功能**不在计划内**：

- ❌ 多宠物系统（增加复杂度，价值存疑）
- ❌ 社交功能（违背本地优先原则）
- ❌ 内购系统（项目开源免费）
- ❌ 微内核架构（理论完美但实际复杂）

---

**下次审阅**: Sprint 5 启动前
